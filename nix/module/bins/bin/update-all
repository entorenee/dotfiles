#!/usr/bin/env zsh

local NOW=$(date +"%Y-%m-%d-%H-%M-%S")
local LOGS="/tmp/update-all-$NOW.txt"
echo -e "$NOW\n" >>$LOGS

function logTask() {
  echo -e "\n$1\n" >>$LOGS
  echo "$1"
}

# Neovim updates
echo "Updating Neovim packages"

gum spin --spinner moon --title "💤 lazy.nvim syncing..." -- nvim --headless "+Lazy! update" +qa
logTask "✅ 💤 lazy.nvim synced"

gum spin --spinner moon --title "🧰 mason.nvim updating" -- nvim --headless "+MasonUpdate" +qa
logTask "✅ 🧰 mason.nvim updated"

# Homebrew updates
gum spin --spinner moon --title "🍻 homebrew updating" --show-output brew update >>$LOGS
logTask "✅ 🍻homebrew updated"

local OUTDATED=$(brew outdated)
logTask "Brew outdated: $OUTDATED"

if test -n "$OUTDATED"; then
  gum spin --spinner moon --title "🍻 homebrew upgrading" --show-output brew upgrade >>$LOGS
  logTask "✅ 🍻 homebrew upgraded"

  gum spin --spinner moon --title "🍻 homebrew cleanup" --show-output brew cleanup >>$LOGS
  logTask "✅ 🍻 homebrew cleaned"
else
  logTask "No outdated brew packages"
fi

gum spin --spinner moon --title "🍻 homebrew doctoring" --show-output brew doctor >>$LOGS
logTask "✅ 🍻 homebrew doctored"

logTask "✅ 💻 update logs captured in $LOGS"
man $LOGS
