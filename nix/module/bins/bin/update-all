#!/usr/bin/env zsh

local NOW=$(date +"%Y-%m-%d-%H-%M-%S")
local LOGS="/tmp/update-all-$NOW.txt"
echo -e "$NOW\n" >>$LOGS

function logTask() {
  echo -e "\n$1\n" >>$LOGS
  echo "$1"
}

# Neovim updates
echo "Updating Neovim packages"

gum spin --spinner moon --title "ğŸ’¤ lazy.nvim syncing..." -- nvim --headless "+Lazy! update" +qa
logTask "âœ… ğŸ’¤ lazy.nvim synced"

gum spin --spinner moon --title "ğŸ§° mason.nvim updating" -- nvim --headless "+MasonUpdate" +qa
logTask "âœ… ğŸ§° mason.nvim updated"

# Homebrew updates
gum spin --spinner moon --title "ğŸ» homebrew updating" --show-output brew update >>$LOGS
logTask "âœ… ğŸ»homebrew updated"

local OUTDATED=$(brew outdated)
logTask "Brew outdated: $OUTDATED"

if test -n "$OUTDATED"; then
  gum spin --spinner moon --title "ğŸ» homebrew upgrading" --show-output brew upgrade >>$LOGS
  logTask "âœ… ğŸ» homebrew upgraded"

  gum spin --spinner moon --title "ğŸ» homebrew cleanup" --show-output brew cleanup >>$LOGS
  logTask "âœ… ğŸ» homebrew cleaned"
else
  logTask "No outdated brew packages"
fi

gum spin --spinner moon --title "ğŸ» homebrew doctoring" --show-output brew doctor >>$LOGS
logTask "âœ… ğŸ» homebrew doctored"

logTask "âœ… ğŸ’» update logs captured in $LOGS"
man $LOGS
