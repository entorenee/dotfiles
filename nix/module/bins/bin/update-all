#!/usr/bin/env zsh

local NOW=$(date +"%Y-%m-%d-%H-%M-%S")
local LOGS="/tmp/update-all-$NOW.txt"
echo -e "$NOW\n" >>$LOGS

local function logNewLine() {
  echo -e "\n" >>$LOGS
}

local function logTask() {
  logNewLine
  echo "$1"
}

local function gumUpdate() {
  local command="$2"
  gum spin --spinner moon --title "$1" --show-output -- $command >>$LOGS
}

# Neovim updates
echo "Updating Neovim packages"

gum spin --spinner moon --title "ğŸ’¤ lazy.nvim syncing..." -- nvim --headless "+Lazy! update" +qa
logTask "âœ… ğŸ’¤ lazy.nvim synced"

gum spin --spinner moon --title "ğŸ§° mason.nvim updating" -- nvim --headless "+MasonUpdate" +qa
logTask "âœ… ğŸ§° mason.nvim updated" 

# Homebrew updates
gumUpdate "ğŸ»homebrew updating" "brew update"
logTask "âœ… ğŸ»homebrew updated"

local OUTDATED=$(brew outdated)
logNewLine

if test -n "$OUTDATED"; then
  gumUpdate "ğŸ» homebrew upgrading" "brew upgrade"
  logTask "âœ… ğŸ» homebrew upgraded"

  gumUpdate "ğŸ» homebrew cleanup" "brew cleanup"
  logTask "âœ… ğŸ» homebrew cleaned"
else
  logTask "No outdated brew packages"
fi

gumUpdate "ğŸ» homebrew doctoring" "brew doctor"
logTask "âœ… ğŸ» homebrew doctored"

logTask "âœ… ğŸ’» update logs captured in $LOGS"
less $LOGS
